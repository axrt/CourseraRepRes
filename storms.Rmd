---
title: 'Storms //TODO: invent some title smth causes the most damage according to NOAA'
output: html_document
---

####*Alex Tuzhikov, August 15 2015*

##Quick preparation:
Loading libraries:

```{r loading libraries}
if(!require("data.table")){
  install.packages("data.table")
  library("data.table")
}
if(!require("plyr")){
  install.packages("plyr")
  library("plyr")
}
if(!require("dplyr")){
  install.packages("dplyr")
  library("dplyr")
}
if(!require("tidyr")){
  install.packages("tidyr")
  library("tidyr")
}
if(!require("knitr")){
  install.packages("knitr")
  library("knitr")
}
if(!require("ggplot2")){
  install.packages("ggplot2")
  library("ggplot2")
}
if(!require("lubridate")){
  install.packages("lubridate")
  library("lubridate")
}
if(!require("R.utils")){
  install.packages("R.utils")
  library("R.utils")
}
```

Setting options:

```{r setoptions}
opts_chunk$set(echo = TRUE,fig.width = 7, fig.height = 7)

```

##Data processing

###Obtaining the data  

```{r data download, cache=TRUE}
#check if the file has alerady been downloaded
storm.data<-"StormData"
storm.data.csv<-paste0(storm.data,".csv")
storm.data.bz<-paste0(storm.data.csv,".bz2")

if(!file.exists(storm.data.bz)){
  #download the file
  download.file(url = "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2", 
                destfile=storm.data.bz, method = "curl")
}
#extract the data and select only the columns that may be valuable for this study
noaa.data<- read.csv(file=storm.data.bz, header=TRUE, stringsAsFactors = FALSE) %>% 
  select(STATE,COUNTYNAME,BGN_DATE,EVTYPE,MAG,FATALITIES,INJURIES,PROPDMG,PROPDMGEXP,CROPDMG,CROPDMGEXP)
```

Apparently, some of the data need to get tidy. See below:

```{r}
head(noaa.data)
```

Here `BGN_DATE` should probably be of a more appropriate class, that represents a date.

```{r cleaning dates}
#simply convert the dates and get rid of the old BGN_DATE column
noaa.data <- noaa.data %>% mutate(EVENT_DATE=mdy_hms(BGN_DATE)) %>% select(-c(BGN_DATE))
```

Now, there is still an issue with the `PROPDMG` value (property damage). Currently,

```{r PROPDMG PROPDMGEXP demo}
unique(noaa.data$PROPDMGEXP)
```

and we can not use these values "as is", so some conversion is due here as well. I will assign a numeric value, which corresponds to some power of ten to each of the values:

```{r PROPDMG PROPDMGEXP fix}
#            "K" "M" ""  "B" "m" "+" "0" "5" "6" "?" "4" "2" "3" "h" "7" "H" "-" "1" "8"
power.val<-c( 3,  6,  0,  9,  6,  0,  0,  5,  6,  0,  4,  2,  3,  0,  7,  2,  0,  1,  8)
val.map<-mapvalues(x = noaa.data$PROPDMGEXP,
          from=c("K","M","", "B","m","+","0","5","6","?","4","2","3","h","7","H","-","1","8"),
          to=sapply(power.val,function(i){return(10^i)}))
rm(power.val)
noaa.data<- noaa.data %>% mutate(PROPDMG=PROPDMG*as.numeric(val.map)) %>% select(-c(PROPDMGEXP))
rm(val.map)
```

Now, the same thing occurs with the `CROPDMG` and `CROPDMGEXP`:

```{r CROPDMG CROPDMGEXP demo and fix}
unique(noaa.data$CROPDMGEXP)
#           ""  "M" "K" "m" "B" "?" "0" "k" "2"
power.val<-c(0,  6,  3,  6,  9,  1,  1,  3,  2)
val.map<-mapvalues(x = noaa.data$CROPDMGEXP,
          from=c("","M","K","m","B","?","0","k","2"),
          to=sapply(power.val,function(i){return(10^i)}))
rm(power.val)
noaa.data<- noaa.data %>% mutate(CROPDMG=CROPDMG*as.numeric(val.map)) %>% select(-c(CROPDMGEXP))
rm(val.map)
```



